# user-permissions

**Используемыей технологический стек:**

Python 3.12, Django 5.1.1, DRF (Django REST framework), API, JWT, PostgreSQL

## Описание проекта.

* В проекте реализована возможность регистрации пользователей по API; аутентификация пользователей по email и паролю с получением JWT-токенов доступа (аналог Login), в дальнейшем аутентификация проходит по JWT-токену; выход из аккаунта (аналог Logout) с добавлением refresh-токена в черный список; реализовано мягкое удаление аккаунта для пользователей, при этом пользователь не удаляется из системы, а помечается, как is_active=True; так же каждый аутентифицированный пользователь может частично редактировать данные своего аккаунта.
* Для управлением авторизацией созданы дополнительные таблицы, реализована возможность редактирования данных в них через API для администратора.
 

## Система разграничения прав доступа.

Для разграничения прав доступа создано отдельное приложение permissions. Для него созданы 2 модели: BusinessElements и Permissions. Через первую осуществляется контроль за теми приложениями, для которых хотим установить свои ограничения. Вторая отвечает за создание прав доступа к конкретному приложению. В Permissions указываются приложения из модели BusinessElements и возможные роли пользователей, список которых ограничен 4 видами: ``guest``, ``user``, ``manager``, ``admin``. Для каждой роли и конкретного приложения устанавливаются следующие типы ограничений типа BoleanField: ``get_list_permission``, ``create_obj_permission``, ``get_obj_permission``, ``update_obj_permission``, ``partial_update_obj_permission``, ``delete_obj_permission``, ``owner_permission``.

Предполагается, что система разграничений будет основана на сопоставлении запрашиваемого метода запроса и допустимого для конкретного представления в приложении, кроме того, должна идти проверка того, что указанные выше типы ограничений разрешены, то есть имеют значения ``True``, для конкретной роли пользователя. У зарегистрированного пользователя по умолчанию создается роль ``guest``, но затем ему можно присвоить другие роли. В этом случае будет происходить перебор по существующим ролям и выставленным в них правам доступа. Возможна организация авторизации с ограничением по конкретной роля/ролям. Везде, где требуется авторизация, изначально пользователь, отправивший запрос, аутентифицируется (проверяется ``is_authenticated``). Для доступа к редактированию ролей пользователей и системе проверки прав доступа добавлена возможность обращения пользователя ``superuser``, который может не иметь соответвующих разрешений на выполнение каких-либо действий в соответсвии со своей ролью.

Для системы выдачи прав доступа в нынешней реализации в папке каждого приложения созданы файлы ``permissions``. В них для каждой view-функции, связанной с этим приложением, созданы права доступа к объектам, к которым обращается данное представление. Кроме основных функций для работы проекта, добавлено тестовое представление, к которому можно обратиться по пути: ``http://127.0.0.1:8000/api/v1/mock-view/``, если проект запущен на локальном сервере. И для пользователей ``test_guest@mail.ru``, ``test_user@mail.ru``, ``test_manager@mail.ru``, ``test_admin@mail.ru`` возможно проверить наличие доступа по указанному адресу для различных типов запроса. Пароль для этих пользователей в базе данных ``test2025``.


## Установка. 
### Запуск проекта на локальной машине.


Клонировать репозиторий и перейти в него в командной строке:

```
git clone https://github.com/dankut25/user-permissions.git
```

```
cd user-permissions
```

Cоздать и активировать виртуальное окружение:

```
python -m venv venv
```

```
source venv/Scripts/activate
```

Обновить установщик pip:

```
python -m pip install --upgrade pip
```

Установить зависимости из файла requirements.txt:

```
pip install -r requirements.txt
```

### Загрузить базу данных на запущенный сервер PostgreSQL.

#### Например в Docker:

Создать новую базу данных, в проекте использовалось имя project_db

``docker exec -it <имя_контейнера> createdb -U <имя_пользователя> <новое_имя_базы_данных>``

Загрузить файл базы данных ``project_db.sql`` в контейнер запущенного сервера

``docker exec -i <имя_контейнера> psql -U <имя_пользователя> -d <новое_имя_базы_данных> < <имя_файла_базы_данных>.sql``

Используемые при создании проекта параметры доступа к базе данных PostgreSQL, запущенной в контейнере Docker:

```
NAME = 'project_db'
USER = 'postgres'
PASSWORD = 'postgres'
HOST = 'localhost'
PORT = '5432'
```

#### Например на сервере:

Создать новую базу данных, в проекте использовалось имя project_db

``createdb -U <имя_пользователя> <имя_базы_данных>``

Загрузить файл базы данных ``project_db.sql`` в контейнер запущенного сервера

``psql -U <имя_пользователя> -d <имя_базы_данных> < <путь/к/файлу>.sql``


### Продолжение установки:

Перейти в папку проекта и выполнить миграции:

```
cd user_permissions
```

```
python manage.py migrate
```

Запустить проект:

```
python manage.py runserver
```

### Доступ к проекту и Админ-панели находятся по адресу:

```
http://127.0.0.1:8000
```
```
http://127.0.0.1:8000/admin
```

### Доступ к проекту как суперпользователь:

Логин: ``superuser@mail.ru`` 
Пароль: ``1q3e5t2w4r6y``


## Примеры запросов:

### Самостоятельная регистрация и вход новых пользователей.

1. Пользователь отправляет POST-запрос с параметрами `email`, `password`, `password_confirm` на `/api/v1/auth/signup/`. Так же возможно сразу указать данные ФИО через поля: `first_name`, `last_name`, `sur_name`.
2. Пользователь отправляет POST-запрос с параметрами `email` и `password` на эндпоинт `/api/v1/auth/login`, в ответе на запрос ему приходят токены "access" и "refresh".
4. В результате пользователь получает токены и может работать с API проекта, отправляя "access" токен с каждым запросом. Токен "refresh" можно использовать для обновления "access" по пути: `/api/v1/auth/token/refresh/`. 
4. После регистрации и получения токена "access" пользователь может отправить PATCH-запрос на эндпоинт `/api/v1/users/me/` и заполнить поля ФИО в своём профайле.
5. Пользователь может выйти из проекта, обратившись по адресу: `/api/v1/auth/logout/` и предоставив в запросе токен "refresh".
6. Пользователь может удалить свой аккаунт, обратившись по адресу: `/api/v1/users/me/delete/`, при этом все выданные токены "refresh" будут добавлены в черный список.  

#### Пример запроса на регистрацию:

```
GET http://127.0.0.1:8000/api/v1/auth/signup/
```

полезные данные

```
{
    "email": "Электронная почта для регистрации. Обязательное поле.",
    "password": "Пароль для регистрации. Обязательное поле",
    "password_confirm": "Подтверждение пароля. Обязательное поле",
    "first_name": "Имя. Необязателньое поле.",
    "last_name": "Фамилия. Необязателньое поле.",
    "sur_name": "Отчество. Необязателньое поле."
}
```

#### Пример запроса на вход и получение токенов доступа:

```
GET http://127.0.0.1:8000/api/v1/auth/login/
```

полезные данные

```
{
    "email": "Электронная почта для регистрации. Обязательное поле.",
    "password": "Пароль, указанный при регистрации. Обязательное поле"
}
```

ответ:

{
    "refresh": "Токен для обновления access.",
    "access": "Основной токен для доступа."
}

#### Пример запроса на выход из аккаунта:

```
GET http://127.0.0.1:8000/api/v1/auth/logout/
```

полезные данные

```
{
    "refresh": "Токен для обновления access."
}
```

### Администратор или суперпользователь могут регулировать роли пользователей и настройки доступа к приложениям.

1. Редактирование ролей пользователей доступно по адресу: `/api/v1/users/role/` и `/api/v1/users/role/<pk=user_id>`. Доступные методы запросов: `get`, `post`, `patch`, `delete`.
2. Создание и редактирование списка приложений для системы регулирвоания доступа находятся по пути: `/api/v1/applications/` и `/api/v1/applications/<slug=короткое имя приложения>`. Доступные методы запросов: `get`, `post`, `patch`, `delete`.
3. Создание и редактирвоание прав доступа для пользователей с определнной ролью с определнному приложению по пути: `/api/v1/permissions/` и `/api/v1/permissions/<pk=id>`. Доступные методы запросов: `get`, `post`, `patch`, `delete`.


#### Пример запроса на создание роли для пользователя:

```
GET http://127.0.0.1:8000/api/v1/users/role/
```

полезные данные

```
{
    "user": "Электронная почта пользователя. Обязательное поле.",
    "role": "Роль пользователя. Не обязательное, по умолчанию будет роль guest."
}
```

#### Пример запроса на создание записи о приложении для регулировки прав доступа:

```
GET http://127.0.0.1:8000/api/v1/applications/
```

полезные данные

```
{
    "name": "Название приложения. Обязательное поле.",
    "slug": "Короткое имя. Обязательное поле."
}
```

#### Пример запроса на создание прав доступа к конкретному приложению с конкретной ролью:

```
GET http://127.0.0.1:8000/api/v1/permissions/
```

полезные данные

```
{
    "business_element": "Название приложения. Обязательное поле.",
    "role": "Короткое имя. Обязательное поле.",
    "get_list_permission": "Доступ к списку объектов 'GET'. По умолчанию false",
    "create_obj_permission": "Доступ к созданию объекта 'POST'. По умолчанию false",
    "get_obj_permission": "Доступ к конкретному объекту 'GET'. По умолчанию false",
    "update_obj_permission": "Полное обновление объекта 'PUT'. По умолчанию false",
    "partial_update_obj_permission": "Частичное обновление объекта 'PATCH'. По умолчанию false",
    "delete_obj_permission": "Доступ к удалению объекта 'DELETE'. По умолчанию false",
    "owner_permission": "Доступ к управлению над созданным объектом. По умолчанию false"
}
```

### Отдельное представление для демонстрации предоставления прав доступа пользователям с разной ролью.

#### Пример запроса после получения прав доступа для уже созданных тестовых пользователей по методам `get`, `post`, `put`, `patch`, `delete`:

```
GET http://127.0.0.1:8000/api/v1/api/v1/mock-view/
```
